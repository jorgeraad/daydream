# 20260212114217 - Persistence

| Field              | Value |
|--------------------|-------|
| **Created**        | 2026-02-12 11:42:20 EST |
| **Last Modified**  | 2026-02-12 11:42:20 EST |
| **Status**         | todo |
| **Branch**         | — |
| **Agent**          | — |
| **Blocked-By**     | 20260212114208 |
| **Touches**        | apps/game/src/SaveManager.ts, apps/game/src/config.ts |
| **References**     | [Design Doc](../../docs/design.md), [PRD](../../docs/prd.md) |

## Description

Implement SQLite persistence via bun:sqlite. Define the database schema (worlds, zones, characters, chronicle_entries, player_state, ai_cache). Build SaveManager to save/load complete world state with transaction batching and dirty tracking. Auto-save every 60 seconds, manual save with Ctrl+S. Save files stored as SQLite databases in ~/.daydream/worlds/. Build a save/load screen to list worlds, create new, or continue.

## Acceptance Criteria

- [ ] SQLite schema: worlds, zones, characters, chronicle_entries, player_state, ai_cache tables
- [ ] WAL mode enabled for concurrent read/write performance
- [ ] Indexes on common query patterns (zone by world, characters by world, chronicle by world+time)
- [ ] SaveManager.saveWorld() writes all dirty state in a single transaction
- [ ] SaveManager.loadWorld() restores full state (zones, characters, chronicle, player)
- [ ] Dirty tracking: only save zones/characters that changed since last save
- [ ] Auto-save every 60 seconds (skipped if no dirty state)
- [ ] Manual save with Ctrl+S triggers immediate save
- [ ] Save files stored in ~/.daydream/worlds/<world-id>.db
- [ ] SaveManager.listWorlds() scans save directory and returns summaries
- [ ] Save/load screen UI (list worlds, create new, continue existing)
- [ ] Unit tests for SQLite schema creation and migrations
- [ ] Unit tests for SaveManager save/load round-trip (write then read back)
- [ ] Unit tests for dirty tracking (mark dirty, save, verify clean)
- [ ] Integration test: create world, save, load, verify state matches

## Implementation Steps

_To be filled in when the task is started._

## Progress Log

### 2026-02-12 11:42:20 EST
Initial creation. Extracted from design doc Sections 10 (Persistence Layer) and Section 16 Step 9. Only depends on engine types — can start earlier than in the original plan.
